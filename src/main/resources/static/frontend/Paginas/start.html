<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sky & Sea</title>
  <meta name="description" content="Pantalla de juego de Sky & Sea.">

  <!-- CSS -->
  <link rel="stylesheet" href="/frontend/css/main.css">

  <!-- Fuente -->
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
</head>

<body class="pagina-start">
  <!-- Fondo -->
  <div class="fondoStart">
    <img src="/frontend/Imagenes/Fondo/FondoVistaDeArriba.png" alt="Fondo de la partida">
  </div>

  <!-- Encabezado con logotipo -->
  <header>
    <div class="titulostart">
      <img src="/frontend/Imagenes/Logo/LetrasSinfondo.png" alt="Logo Sky & Sea">
    </div>
  </header>

  <!-- Contenido principal con la cuadrícula del juego -->
  <main>
    <div class="tablero-wrapper">
      <div class="tablero-header">
        <div class="tablero-info">
          <div id="indicadorJugador" class="indicador-jugador" aria-live="polite"></div>
          <div id="indicadorTurno" class="indicador-turno" aria-live="polite"></div>
          <div id="cronometroTurno" class="cronometro-turno" aria-live="polite"></div>
        </div>
      </div>
      <div class="cuadricula" id="grid"></div>
      <div class="tablero-acciones">
        <button id="btnMover" class="game-btn boton-accion" type="button" disabled>MOVER</button>
        <button id="btnDisparar" class="game-btn boton-accion" type="button">DISPARAR</button>
        <button id="btnPlay" class="game-btn boton-play" type="button" aria-label="Play" title="Play"></button>
      </div>
    </div>
  </main>

  <section class="hud-inferior" aria-live="polite">
    <div class="hud-bloque hud-tu-equipo">
      <div class="hud-encabezado">
        <div class="hud-titulo" id="hudTituloTuEquipo">TU EQUIPO</div>
        <div class="hud-subtitulo" id="hudTipoTuEquipo">-</div>
      </div>
      <div class="hud-metricas">
        <div class="hud-metrica">
          <img id="hudIconDronTu" class="hud-icono" src="/frontend/Imagenes/ContadorDeVidas/DronAereoTuEquipo.png" alt="Drones tu equipo">
          <span id="hudDronesTu" class="hud-valor">-</span>
        </div>
        <div class="hud-metrica">
          <img id="hudIconMunicionTu" class="hud-icono" src="/frontend/Imagenes/ContadorDeVidas/BombaTuEquipo.png" alt="Munición tu equipo">
          <span id="hudMunicionTu" class="hud-valor">-</span>
        </div>
        <div class="hud-metrica">
          <img id="hudIconPortaTu" class="hud-icono hud-icono-porta" src="/frontend/Imagenes/ContadorDeVidas/PortaTuEquipo.png" alt="Vida porta tu equipo">
          <span id="hudVidaTu" class="hud-valor">-/-</span>
        </div>
      </div>
    </div>

    <div class="hud-bloque hud-equipo-enemigo">
      <div class="hud-encabezado">
        <div class="hud-titulo" id="hudTituloEnemigo">EQUIPO ENEMIGO</div>
        <div class="hud-subtitulo" id="hudTipoEnemigo">-</div>
      </div>
      <div class="hud-metricas">
        <div class="hud-metrica">
          <img id="hudIconDronEnemigo" class="hud-icono" src="/frontend/Imagenes/ContadorDeVidas/DronAereoEquipoEnemigo.png" alt="Drones equipo enemigo">
          <span id="hudDronesEnemigo" class="hud-valor">-</span>
        </div>
        <div class="hud-metrica">
          <img id="hudIconMunicionEnemigo" class="hud-icono" src="/frontend/Imagenes/ContadorDeVidas/BombaEquipoEnemigo.png" alt="Munición equipo enemigo">
          <span id="hudMunicionEnemigo" class="hud-valor">-</span>
        </div>
        <div class="hud-metrica">
          <img id="hudIconPortaEnemigo" class="hud-icono hud-icono-porta" src="/frontend/Imagenes/ContadorDeVidas/PortaEquipoEnemigo.png" alt="Vida porta equipo enemigo">
          <span id="hudVidaEnemigo" class="hud-valor">-/-</span>
        </div>
      </div>
    </div>
  </section>

  <!-- Pie de página reservado -->
  <footer class="footer"></footer>

  <script>
    const API_BASE = (window.location.protocol === 'file:')
      ? 'http://localhost:8080'
      : '';
    const API = `${API_BASE}/api/game`;

    function getSessionValue(key) {
      const fromSession = sessionStorage.getItem(key);
      if (fromSession !== null) {
        return fromSession;
      }
      const legacyValue = localStorage.getItem(key);
      if (legacyValue !== null) {
        sessionStorage.setItem(key, legacyValue);
        localStorage.removeItem(key);
      }
      return legacyValue;
    }

    function setSessionValue(key, value) {
      sessionStorage.setItem(key, value);
      localStorage.removeItem(key);
    }

    let playerId = getSessionValue('playerId');
    const indicadorJugador = document.getElementById('indicadorJugador');
    const indicadorTurno = document.getElementById('indicadorTurno');
    const cronometroTurno = document.getElementById('cronometroTurno');
    const btnMover = document.getElementById('btnMover');
    const btnDisparar = document.getElementById('btnDisparar');
    const hudTipoTuEquipo = document.getElementById('hudTipoTuEquipo');
    const hudTipoEnemigo = document.getElementById('hudTipoEnemigo');
    const hudDronesTu = document.getElementById('hudDronesTu');
    const hudDronesEnemigo = document.getElementById('hudDronesEnemigo');
    const hudMunicionTu = document.getElementById('hudMunicionTu');
    const hudMunicionEnemigo = document.getElementById('hudMunicionEnemigo');
    const hudVidaTu = document.getElementById('hudVidaTu');
    const hudVidaEnemigo = document.getElementById('hudVidaEnemigo');
    const hudIconDronTu = document.getElementById('hudIconDronTu');
    const hudIconDronEnemigo = document.getElementById('hudIconDronEnemigo');
    const hudIconMunicionTu = document.getElementById('hudIconMunicionTu');
    const hudIconMunicionEnemigo = document.getElementById('hudIconMunicionEnemigo');
    const hudIconPortaTu = document.getElementById('hudIconPortaTu');
    const hudIconPortaEnemigo = document.getElementById('hudIconPortaEnemigo');
    let numeroJugadorActual = Number(getSessionValue('numeroJugador'));
    const TIEMPO_TURNO_SEGUNDOS = 30;
    let duracionTurnoSegundos = TIEMPO_TURNO_SEGUNDOS;
    let segundosRestantesTurno = 0;
    let ultimoNumeroTurno = null;
    let autoPasandoTurno = false;
    let recuperandoSesion = false;
    let alertaSesionMostrada = false;
    function getPlayerIdActual() {
      if (!playerId) {
        playerId = getSessionValue('playerId');
      }
      return playerId;
    }

    async function intentarRecuperarSesion() {
      if (recuperandoSesion) return false;
      const nombreUsuario = getSessionValue('nombreUsuario');
      if (!nombreUsuario) return false;

      recuperandoSesion = true;
      try {
        const join = await apiRequest(`/join?nombre=${encodeURIComponent(nombreUsuario)}`, 'POST');
        if (!join || !join.playerId) {
          return false;
        }

        playerId = join.playerId;
        setSessionValue('playerId', join.playerId);
        if (join.idPartida) setSessionValue('idPartida', join.idPartida);
        if (join.equipo) setSessionValue('equipoAsignado', join.equipo);
        if (join.numeroJugador === 1 || join.numeroJugador === 2) {
          setSessionValue('numeroJugador', String(join.numeroJugador));
        }
        alertaSesionMostrada = false;
        return true;
      } catch (_) {
        return false;
      } finally {
        recuperandoSesion = false;
      }
    }


    // el backend controlarÃ¡ si el jugador ya realizÃ³ una acciÃ³n en el turno,
    // el frontend no guarda este estado en almacenamiento persistente compartido.

    function actualizarIndicadorJugador(numeroJugador) {
      if (!indicadorJugador) return;

      indicadorJugador.classList.remove('jugador-1', 'jugador-2');

      if (numeroJugador === 1) {
        indicadorJugador.textContent = 'JUGADOR 1';
        indicadorJugador.classList.add('jugador-1');
        return;
      }

      if (numeroJugador === 2) {
        indicadorJugador.textContent = 'JUGADOR 2';
        indicadorJugador.classList.add('jugador-2');
        return;
      }

      indicadorJugador.textContent = 'JUGADOR';
    }

    function actualizarIndicadorTurno(esMiTurno) {
      if (!indicadorTurno) return;

      indicadorTurno.classList.remove('tu-turno', 'otro-turno');

      if (esMiTurno === true) {
        indicadorTurno.textContent = 'TU TURNO';
        indicadorTurno.classList.add('tu-turno');
        return;
      }

      if (esMiTurno === false) {
        indicadorTurno.textContent = 'TURNO ENEMIGO';
        indicadorTurno.classList.add('otro-turno');
        return;
      }

      indicadorTurno.textContent = '';
    }

    function actualizarCronometroTurnoVisual(mostrar) {
      if (!cronometroTurno) return;
      if (mostrar) {
        cronometroTurno.textContent = `${Math.max(segundosRestantesTurno, 0)}s`;
      } else {
        cronometroTurno.textContent = '';
      }
    }

    function sincronizarCronometroTurno(esMiTurno, segundosRestantes, duracionSegundos) {
      if (Number.isFinite(duracionSegundos) && duracionSegundos > 0) {
        duracionTurnoSegundos = duracionSegundos;
      }

      if (Number.isFinite(segundosRestantes)) {
        segundosRestantesTurno = Math.max(0, segundosRestantes);
      } else {
        segundosRestantesTurno = duracionTurnoSegundos;
      }

      actualizarCronometroTurnoVisual(esMiTurno === true);
    }

    // entrega: función genérica para terminar el turno. Se puede invocar
    // desde el timeout o desde un botón manual. Retorna la respuesta si hay OK
    // y lanza error en caso contrario.
    async function pasarTurno() {
      const playerIdActual = getPlayerIdActual();
      if (autoPasandoTurno || !playerIdActual) return;
      autoPasandoTurno = true;
      try {
        const data = await apiRequest(`/endTurn2?playerId=${encodeURIComponent(playerIdActual)}`, 'POST');
        // limpieza de interfaz al completar el cambio de turno
        if (typeof exitMoveMode === 'function') exitMoveMode();
        if (typeof exitShootMode === 'function') exitShootMode();
        document.querySelectorAll('.celda.seleccionado').forEach((el) => el.classList.remove('seleccionado'));
        selectedDron = null;
        if (btnMover) btnMover.disabled = true;
        if (btnDisparar) btnDisparar.disabled = true;
        await refreshPartidaState();
        return data;
      } finally {
        autoPasandoTurno = false;
      }
    }

    const numeroGuardado = Number(getSessionValue('numeroJugador'));
    if (numeroGuardado === 1 || numeroGuardado === 2) {
      actualizarIndicadorJugador(numeroGuardado);
    } else {
      actualizarIndicadorJugador(null);
    }

    // global helpers used by move logic
    let celdas = [];                       // será llenado cuando se cree la cuadrícula

    // --- selección y movimiento de dron ---
    let selectedDron = null;               // {id,fila,col,cell}
    let moveMode = false;
    let moveCells = [];                    // array de {cell,handler}
    let shootMode = false;
    let shootCells = [];

    function exitMoveMode() {
      moveMode = false;
      moveCells.forEach(({cell, handler}) => {
        cell.classList.remove('movible');
        cell.removeEventListener('click', handler);
      });
      moveCells = [];
      // reactivar botón si hay dron seleccionado
      if (btnMover) {
        btnMover.disabled = !selectedDron;
      }
    }

    function exitShootMode() {
      shootMode = false;
      shootCells.forEach(({cell, handler}) => {
        cell.classList.remove('movible');
        cell.removeEventListener('click', handler);
      });
      shootCells = [];
      if (btnDisparar) {
        btnDisparar.disabled = !selectedDron;
      }
    }

    function limpiarSeleccionLocal() {
      exitMoveMode();
      exitShootMode();
      document.querySelectorAll('.celda.seleccionado').forEach((el) => el.classList.remove('seleccionado'));
      selectedDron = null;
      if (btnMover) btnMover.disabled = true;
      if (btnDisparar) btnDisparar.disabled = true;
    }

    function enterShootMode(reintento = false) {
      if (!selectedDron || shootMode) return;
      shootMode = true;

      (async () => {
        try {
          const playerIdShoot = getPlayerIdActual();
          if (!playerIdShoot) {
            alert('Jugador no identificado');
            exitShootMode();
            return;
          }

          const disponibles = await apiRequest(`/availableShots2?playerId=${encodeURIComponent(playerIdShoot)}`);
          if (!disponibles.ok) {
            if (!reintento && disponibles.estado === 'SIN_DRON_SELECCIONADO' && selectedDron?.id) {
              const sel = await apiRequest(
                `/selectDrone2?playerId=${encodeURIComponent(playerIdShoot)}&dronId=${encodeURIComponent(selectedDron.id)}`,
                'POST'
              );
              if (sel?.ok) {
                exitShootMode();
                enterShootMode(true);
                return;
              }
            }
            alert('No se puede disparar: ' + (disponibles.estado || 'ERROR'));
            exitShootMode();
            return;
          }

          const celdasDisponibles = disponibles.celdas || [];
          celdasDisponibles.forEach(({x, y}) => {
            const celdaData = celdas.find(c => c.col === x && c.fila === y);
            if (!celdaData) return;

            const celda = celdaData.celda;
            celda.classList.add('movible');
            const handler = async () => {
              try {
                const playerIdShootActual = getPlayerIdActual();
                if (!playerIdShootActual) {
                  alert('Jugador no identificado');
                  return;
                }

                const data = await apiRequest(
                  `/shoot2?playerId=${encodeURIComponent(playerIdShootActual)}&fila=${y}&col=${x}`,
                  'POST'
                );

                if (data.ok) {
                  if (btnDisparar) btnDisparar.disabled = true;
                  exitShootMode();
                  await refreshPartidaState();
                } else {
                  alert('Disparo inválido: ' + (data.estado || 'ERROR'));
                }
              } catch (err) {
                alert('Error al disparar: ' + err.message);
              }
            };

            celda.addEventListener('click', handler);
            shootCells.push({ cell: celda, handler });
          });
        } catch (error) {
          alert('No se pudieron obtener disparos válidos: ' + error.message);
          exitShootMode();
        }
      })();
    }

    function enterMoveMode(reintento = false) {
      if (!selectedDron || moveMode) return;
      moveMode = true;
      (async () => {
        try {
          const playerIdMover = getPlayerIdActual();
          if (!playerIdMover) {
            alert('Jugador no identificado');
            exitMoveMode();
            return;
          }

          const disponibles = await apiRequest(`/availableMoves2?playerId=${encodeURIComponent(playerIdMover)}`);
          if (!disponibles.ok) {
            if (!reintento && disponibles.estado === 'SIN_DRON_SELECCIONADO' && selectedDron?.id) {
              const sel = await apiRequest(
                `/selectDrone2?playerId=${encodeURIComponent(playerIdMover)}&dronId=${encodeURIComponent(selectedDron.id)}`,
                'POST'
              );
              if (sel?.ok) {
                exitMoveMode();
                enterMoveMode(true);
                return;
              }
            }
            alert('No se puede mover: ' + (disponibles.estado || 'ERROR'));
            exitMoveMode();
            return;
          }

          const celdasDisponibles = disponibles.celdas || [];
          celdasDisponibles.forEach(({x, y}) => {
            const celdaData = celdas.find(c => c.col === x && c.fila === y);
            if (!celdaData) return;

            const celda = celdaData.celda;
            celda.classList.add('movible');
            const handler = async () => {
              try {
                const playerIdMoverActual = getPlayerIdActual();
                if (!playerIdMoverActual) {
                  alert('Jugador no identificado');
                  return;
                }
                const data = await apiRequest(
                  `/move2?playerId=${encodeURIComponent(playerIdMoverActual)}&fila=${y}&col=${x}`,
                  'POST'
                );
                if (data.ok) {
                  const oldCell = selectedDron.cell;
                  const img = oldCell.querySelector('img');
                  if (img) celda.appendChild(img);
                  celda.dataset.dronId = selectedDron.id;
                  delete oldCell.dataset.dronId;
                  oldCell.classList.remove('ocupada-dron','seleccionado');
                  celda.classList.add('ocupada-dron','seleccionado');
                  selectedDron.cell = celda;
                  selectedDron.fila = y;
                  selectedDron.col = x;

                  if (btnMover) btnMover.disabled = true;
                  exitMoveMode();
                } else {
                  alert('Movimiento inválido: ' + (data.estado || 'ERROR'));
                }
              } catch (err) {
                alert('Error al mover dron: ' + (err?.message || 'ERROR'));
              }
            };
            celda.addEventListener('click', handler);
            moveCells.push({cell: celda, handler});
          });
        } catch (error) {
          alert('No se pudieron obtener movimientos válidos: ' + error.message);
          exitMoveMode();
        }
      })();
    }

    function estrategiaDefaultPorEquipo(equipo) {
      return equipo === 'AEREO' ? 'Aereo1' : 'Naval1';
    }

    function estrategiaValidaParaEquipo(estrategia, equipo) {
      if (!estrategia) return false;
      if (equipo === 'AEREO') return estrategia.startsWith('Aereo');
      return estrategia.startsWith('Naval');
    }

    function equipoContrario(equipo) {
      return equipo === 'AEREO' ? 'NAVAL' : 'AEREO';
    }

    function nombreEquipo(equipo) {
      return equipo === 'AEREO' ? 'Aéreo' : 'Naval';
    }

    function impactosMaximosPorta(equipo) {
      return equipo === 'AEREO' ? 6 : 3;
    }

    function obtenerRutasIconosPorEquipo(equipo, esTuEquipo) {
      if (equipo === 'AEREO') {
        return {
          dron: esTuEquipo
            ? '/frontend/Imagenes/ContadorDeVidas/DronAereoTuEquipo.png'
            : '/frontend/Imagenes/ContadorDeVidas/DronAereoEquipoEnemigo.png',
          municion: esTuEquipo
            ? '/frontend/Imagenes/ContadorDeVidas/BombaTuEquipo.png'
            : '/frontend/Imagenes/ContadorDeVidas/BombaEquipoEnemigo.png',
          porta: esTuEquipo
            ? '/frontend/Imagenes/ContadorDeVidas/PortaTuEquipo.png'
            : '/frontend/Imagenes/ContadorDeVidas/PortaEquipoEnemigo.png'
        };
      }

      return {
        dron: esTuEquipo
          ? '/frontend/Imagenes/ContadorDeVidas/DronMisilTuEquipo.png'
          : '/frontend/Imagenes/ContadorDeVidas/DronNavalEquipoEnemigo.png',
        municion: esTuEquipo
          ? '/frontend/Imagenes/ContadorDeVidas/MisilTuEquipo.png'
          : '/frontend/Imagenes/ContadorDeVidas/MisilEquipoEnemigo.png',
        porta: esTuEquipo
          ? '/frontend/Imagenes/ContadorDeVidas/PortaTuEquipo.png'
          : '/frontend/Imagenes/ContadorDeVidas/PortaEquipoEnemigo.png'
      };
    }

    function calcularResumenEquipo(board, equipo, resumenPreferido, resumenAlterno) {
      const resumenMi = board?.resumenMiEquipo;
      const resumenEnemigo = board?.resumenEnemigo;
      const candidatos = [resumenPreferido, resumenAlterno, resumenMi, resumenEnemigo].filter(Boolean);
      const maxEsperado = impactosMaximosPorta(equipo);

      let resumenBackend = candidatos.find(r => r?.equipo === equipo);
      if (!resumenBackend) {
        resumenBackend = candidatos.find(r => r?.impactosMaximosPorta === maxEsperado);
      }
      if (!resumenBackend) {
        resumenBackend = candidatos.find(r =>
          (r?.dronesActivos ?? 0) > 0 ||
          (r?.municionTotal ?? 0) > 0 ||
          (r?.impactosRestantesPorta ?? 0) > 0
        );
      }
      if (!resumenBackend) {
        resumenBackend = candidatos[0] || null;
      }

      if (resumenBackend) {
        return {
          vidaRestante: resumenBackend.impactosRestantesPorta ?? 0,
          vidaMax: resumenBackend.impactosMaximosPorta ?? impactosMaximosPorta(equipo),
          dronesActivos: resumenBackend.dronesActivos ?? 0,
          municionRestante: resumenBackend.municionTotal ?? 0
        };
      }

      const drones = (board.drones || []).filter(d => d.equipo === equipo && !d.destruido);
      const porta = (board.portas || []).find(p => p.equipo === equipo);
      const vidaMax = impactosMaximosPorta(equipo);
      const vidaRestante = porta ? porta.impactosRestantes : 0;
      const dronesActivos = drones.length;
      const municionRestante = drones.reduce((total, dron) => total + (dron.municion || 0), 0);

      return {
        vidaRestante,
        vidaMax,
        dronesActivos,
        municionRestante
      };
    }

    function actualizarHudInferior(board) {
      if (!board) return;

      const miEquipo = board.miEquipo || getSessionValue('equipoAsignado') || 'NAVAL';
      const enemigo = equipoContrario(miEquipo);

      const resumenTu = calcularResumenEquipo(board, miEquipo, board?.resumenMiEquipo, board?.resumenEnemigo);
      const resumenEnemigo = calcularResumenEquipo(board, enemigo, board?.resumenEnemigo, board?.resumenMiEquipo);

      if (hudTipoTuEquipo) hudTipoTuEquipo.textContent = nombreEquipo(miEquipo);
      if (hudTipoEnemigo) hudTipoEnemigo.textContent = nombreEquipo(enemigo);

      if (hudDronesTu) hudDronesTu.textContent = String(resumenTu.dronesActivos);
      if (hudDronesEnemigo) hudDronesEnemigo.textContent = String(resumenEnemigo.dronesActivos);
      if (hudMunicionTu) hudMunicionTu.textContent = String(resumenTu.municionRestante);
      if (hudMunicionEnemigo) hudMunicionEnemigo.textContent = String(resumenEnemigo.municionRestante);
      if (hudVidaTu) hudVidaTu.textContent = `${resumenTu.vidaRestante}/${resumenTu.vidaMax}`;
      if (hudVidaEnemigo) hudVidaEnemigo.textContent = `${resumenEnemigo.vidaRestante}/${resumenEnemigo.vidaMax}`;

      const iconosTu = obtenerRutasIconosPorEquipo(miEquipo, true);
      const iconosEnemigo = obtenerRutasIconosPorEquipo(enemigo, false);

      if (hudIconDronTu) hudIconDronTu.src = iconosTu.dron;
      if (hudIconMunicionTu) hudIconMunicionTu.src = iconosTu.municion;
      if (hudIconPortaTu) hudIconPortaTu.src = iconosTu.porta;

      if (hudIconDronEnemigo) hudIconDronEnemigo.src = iconosEnemigo.dron;
      if (hudIconMunicionEnemigo) hudIconMunicionEnemigo.src = iconosEnemigo.municion;
      if (hudIconPortaEnemigo) hudIconPortaEnemigo.src = iconosEnemigo.porta;
    }

    async function apiRequest(path, method = 'GET') {
      const response = await fetch(`${API}${path}`, { method });
      const raw = await response.text();
      let data = null;

      if (raw) {
        try {
          data = JSON.parse(raw);
        } catch (_) {
          throw new Error(`Respuesta no válida del servidor (HTTP ${response.status})`);
        }
      }

      if (!response.ok) {
        throw new Error(data?.error || `HTTP_${response.status}`);
      }
      if (data?.error) {
        throw new Error(data.error);
      }

      return data || {};
    }

    async function refreshPartidaState() {
      let playerIdActual = getPlayerIdActual();
      if (!playerIdActual) {
        const recuperado = await intentarRecuperarSesion();
        if (!recuperado) {
          if (!alertaSesionMostrada) {
            alertaSesionMostrada = true;
            alert('No se pudo recuperar tu sesión. Vuelve a entrar desde INICIO.');
          }
          return;
        }
        playerIdActual = getPlayerIdActual();
      }

      try {
        const state = await apiRequest(`/state2?playerId=${encodeURIComponent(playerIdActual)}`);

        if (state.equipo) {
          setSessionValue('equipoAsignado', state.equipo);
        }

        if (state.numeroJugador === 1 || state.numeroJugador === 2) {
          numeroJugadorActual = state.numeroJugador;
          setSessionValue('numeroJugador', String(state.numeroJugador));
          actualizarIndicadorJugador(state.numeroJugador);

          const numeroTurnoRecibido = Number(state.numeroTurno);
          if (Number.isFinite(numeroTurnoRecibido)) {
            if (ultimoNumeroTurno !== null && numeroTurnoRecibido !== ultimoNumeroTurno) {
              limpiarSeleccionLocal();
            }
            ultimoNumeroTurno = numeroTurnoRecibido;
          }

          if (state.turnoDe && state.equipo && state.estadoPartida === 'EN_JUEGO') {
            const esMiTurno = state.esMiTurno === true || state.turnoDe === state.equipo;
            actualizarIndicadorTurno(esMiTurno);
            sincronizarCronometroTurno(
              esMiTurno,
              Number(state.segundosRestantesTurno),
              Number(state.duracionTurnoSegundos)
            );

            // controlar habilitación de botón mover
            if (btnMover) {
              if (!esMiTurno) {
                limpiarSeleccionLocal();
              } else {
                btnMover.disabled = !selectedDron;
              }
            }
          } else {
            sincronizarCronometroTurno(false, 0, Number(state.duracionTurnoSegundos));
          }
        } else {
          sincronizarCronometroTurno(false, 0, Number(state.duracionTurnoSegundos));
        }

        try {
          const board = await apiRequest(`/board?playerId=${encodeURIComponent(playerIdActual)}`);
          actualizarRenderDronesDesdeBoard(board);
          actualizarHudInferior(board);
        } catch (errBoard) {
          console.warn('No se pudo actualizar HUD inferior:', errBoard.message);
        }
      } catch (error) {
        sincronizarCronometroTurno(false, 0, duracionTurnoSegundos);
        if (String(error.message || '').includes('PLAYER_NO_ENCONTRADO')) {
          await intentarRecuperarSesion();
          return;
        }
        console.warn('Error al refrescar estado de partida:', error.message);
      }
    }

    // ====== DEFINICIÓN DE FORMACIONES ======
    const formaciones = {
      Naval1: {
        drones: [
          { fila: 0, col: 12, tipo: 'DronMisil' },
          { fila: 2, col: 11, tipo: 'DronMisil' },
          { fila: 2, col: 14, tipo: 'DronMisil' },
          { fila: 2, col: 17, tipo: 'DronMisil' },
          { fila: 3, col: 11, tipo: 'DronMisil' },
          { fila: 5, col: 11, tipo: 'DronMisil' }
        ],
        puertos: [
          { fila: 0, col: 13, tipo: 'PortaNaval' },
          { fila: 0, col: 14, tipo: 'PortaNaval' },
          { fila: 0, col: 15, tipo: 'PortaNaval' },
          { fila: 0, col: 16, tipo: 'PortaNaval' },
          { fila: 0, col: 17, tipo: 'PortaNaval' },
          { fila: 0, col: 18, tipo: 'PortaNaval' },
          { fila: 0, col: 19, tipo: 'PortaNaval' }
        ]
      },
      Naval2: {
        drones: [
          { fila: 2, col: 10, tipo: 'DronMisil' },
          { fila: 4, col: 11, tipo: 'DronMisil' },
          { fila: 6, col: 10, tipo: 'DronMisil' },
          { fila: 8, col: 11, tipo: 'DronMisil' },
          { fila: 4, col: 17, tipo: 'DronMisil' },
          { fila: 7, col: 17, tipo: 'DronMisil' }
        ],
        puertos: [
          { fila: 2, col: 19, tipo: 'PortaNaval' },
          { fila: 3, col: 19, tipo: 'PortaNaval' },
          { fila: 4, col: 19, tipo: 'PortaNaval' },
          { fila: 5, col: 19, tipo: 'PortaNaval' },
          { fila: 6, col: 19, tipo: 'PortaNaval' },
          { fila: 7, col: 19, tipo: 'PortaNaval' },
          { fila: 8, col: 19, tipo: 'PortaNaval' }
        ]
      },
      Naval3: {
        drones: [
          { fila: 0, col: 11, tipo: 'DronMisil' },
          { fila: 3, col: 11, tipo: 'DronMisil' },
          { fila: 3, col: 13, tipo: 'DronMisil' },
          { fila: 6, col: 11, tipo: 'DronMisil' },
          { fila: 6, col: 13, tipo: 'DronMisil' },
          { fila: 9, col: 11, tipo: 'DronMisil' }
        ],
        puertos: [
          { fila: 8, col: 13, tipo: 'PortaNaval' },
          { fila: 8, col: 14, tipo: 'PortaNaval' },
          { fila: 8, col: 15, tipo: 'PortaNaval' },
          { fila: 8, col: 16, tipo: 'PortaNaval' },
          { fila: 8, col: 17, tipo: 'PortaNaval' },
          { fila: 8, col: 18, tipo: 'PortaNaval' },
          { fila: 8, col: 19, tipo: 'PortaNaval' }
        ]
      },
      Aereo1: {
        drones: [
          { fila: 0, col: 5, tipo: 'DronAereo' },
          { fila: 1, col: 5, tipo: 'DronAereo' },
          { fila: 3, col: 1, tipo: 'DronAereo' },
          { fila: 4, col: 2, tipo: 'DronAereo' },
          { fila: 5, col: 1, tipo: 'DronAereo' },
          { fila: 5, col: 3, tipo: 'DronAereo' },
          { fila: 6, col: 2, tipo: 'DronAereo' },
          { fila: 6, col: 4, tipo: 'DronAereo' },
          { fila: 7, col: 1, tipo: 'DronAereo' },
          { fila: 7, col: 3, tipo: 'DronAereo' },
          { fila: 8, col: 2, tipo: 'DronAereo' },
          { fila: 9, col: 1, tipo: 'DronAereo' }
        ],
        puertos: [
          { fila: 0, col: 0, tipo: 'PortaAereo' },
          { fila: 0, col: 1, tipo: 'PortaAereo' },
          { fila: 0, col: 2, tipo: 'PortaAereo' },
          { fila: 0, col: 3, tipo: 'PortaAereo' },
          { fila: 0, col: 4, tipo: 'PortaAereo' },
          { fila: 1, col: 0, tipo: 'PortaAereo' },
          { fila: 1, col: 1, tipo: 'PortaAereo' },
          { fila: 1, col: 2, tipo: 'PortaAereo' },
          { fila: 1, col: 3, tipo: 'PortaAereo' },
          { fila: 1, col: 4, tipo: 'PortaAereo' }
        ]
      },
      Aereo2: {
        drones: [
          { fila: 0, col: 1, tipo: 'DronAereo' },
          { fila: 0, col: 3, tipo: 'DronAereo' },
          { fila: 0, col: 5, tipo: 'DronAereo' },
          { fila: 2, col: 1, tipo: 'DronAereo' },
          { fila: 2, col: 3, tipo: 'DronAereo' },
          { fila: 2, col: 5, tipo: 'DronAereo' },
          { fila: 4, col: 1, tipo: 'DronAereo' },
          { fila: 4, col: 3, tipo: 'DronAereo' },
          { fila: 4, col: 5, tipo: 'DronAereo' },
          { fila: 6, col: 1, tipo: 'DronAereo' },
          { fila: 6, col: 3, tipo: 'DronAereo' },
          { fila: 6, col: 5, tipo: 'DronAereo' }
        ],
        puertos: [
          { fila: 8, col: 1, tipo: 'PortaAereo' },
          { fila: 8, col: 2, tipo: 'PortaAereo' },
          { fila: 8, col: 3, tipo: 'PortaAereo' },
          { fila: 8, col: 4, tipo: 'PortaAereo' },
          { fila: 8, col: 5, tipo: 'PortaAereo' },
          { fila: 9, col: 1, tipo: 'PortaAereo' },
          { fila: 9, col: 2, tipo: 'PortaAereo' },
          { fila: 9, col: 3, tipo: 'PortaAereo' },
          { fila: 9, col: 4, tipo: 'PortaAereo' },
          { fila: 9, col: 5, tipo: 'PortaAereo' }
        ]
      },
      Aereo3: {
        drones: [
          { fila: 0, col: 3, tipo: 'DronAereo' },
          { fila: 1, col: 2, tipo: 'DronAereo' },
          { fila: 1, col: 5, tipo: 'DronAereo' },
          { fila: 2, col: 3, tipo: 'DronAereo' },
          { fila: 3, col: 2, tipo: 'DronAereo' },
          { fila: 4, col: 3, tipo: 'DronAereo' },
          { fila: 4, col: 5, tipo: 'DronAereo' },
          { fila: 5, col: 2, tipo: 'DronAereo' },
          { fila: 6, col: 3, tipo: 'DronAereo' },
          { fila: 7, col: 2, tipo: 'DronAereo' },
          { fila: 7, col: 5, tipo: 'DronAereo' },
          { fila: 8, col: 3, tipo: 'DronAereo' }
        ],
        puertos: [
          { fila: 2, col: 0, tipo: 'PortaAereo' },
          { fila: 2, col: 1, tipo: 'PortaAereo' },
          { fila: 3, col: 0, tipo: 'PortaAereo' },
          { fila: 3, col: 1, tipo: 'PortaAereo' },
          { fila: 4, col: 0, tipo: 'PortaAereo' },
          { fila: 4, col: 1, tipo: 'PortaAereo' },
          { fila: 5, col: 0, tipo: 'PortaAereo' },
          { fila: 5, col: 1, tipo: 'PortaAereo' },
          { fila: 6, col: 0, tipo: 'PortaAereo' },
          { fila: 6, col: 1, tipo: 'PortaAereo' }
        ]
      }
    };

    function normalizarTipoPlantilla(estrategiaSeleccionada) {
      if (!estrategiaSeleccionada) return null;
      const s = estrategiaSeleccionada.trim().toUpperCase();
      if (s.startsWith('AEREO') || s.startsWith('NAVAL')) return estrategiaSeleccionada;
      return null;
    }

    function convertirBoardAFormacion(board, equipoAsignado) {
      const porta = (board.portas || []).find(p => p.equipo === equipoAsignado);
      const drones = (board.drones || [])
        .filter(d => d.equipo === equipoAsignado && !d.destruido)
        .map(d => ({
          id: d.id,                    // conservar identificador del dron
          fila: d.y,
          col: d.x,
          tipo: d.tipo === 'DRON_AEREO' ? 'DronAereo' : 'DronMisil'
        }));

      const puertos = porta
        ? porta.celdas.map(c => ({
            fila: c.y,
            col: c.x,
            tipo: equipoAsignado === 'AEREO' ? 'PortaAereo' : 'PortaNaval'
          }))
        : [];

      return { puertos, drones };
    }

    function limpiarRenderDronesTablero() {
      celdas.forEach(({ celda }) => {
        celda.classList.remove('ocupada-dron', 'seleccionado');
        delete celda.dataset.dronId;
        celda.querySelectorAll('img.elemento-formacion').forEach((img) => img.remove());
      });
    }

    function actualizarRenderDronesDesdeBoard(board) {
      if (!board || !Array.isArray(board.drones)) return;
      const miEquipo = board.miEquipo || getSessionValue('equipoAsignado');

      const dronesObjetivo = new Map();
      board.drones.forEach((dron) => {
        if (!dron || dron.destruido) return;
        if (miEquipo && dron.equipo !== miEquipo) return;
        if (!dron.id) return;

        const fila = Number(dron.y);
        const col = Number(dron.x);
        if (!Number.isFinite(fila) || !Number.isFinite(col)) return;

        dronesObjetivo.set(String(dron.id), {
          id: String(dron.id),
          fila,
          col,
          tipo: dron.tipo
        });
      });

      const dronesActuales = new Map();
      celdas.forEach(({ celda, fila, col }) => {
        const dronId = celda.dataset.dronId;
        if (!dronId) return;
        dronesActuales.set(String(dronId), { celda, fila, col });
      });

      dronesActuales.forEach((renderActual, dronId) => {
        if (dronesObjetivo.has(dronId)) return;
        renderActual.celda.classList.remove('ocupada-dron', 'seleccionado');
        delete renderActual.celda.dataset.dronId;
        renderActual.celda.querySelectorAll('img.elemento-formacion').forEach((img) => img.remove());
      });

      const idsVivos = new Set();
      dronesObjetivo.forEach((dron) => {
        const celdaData = celdas.find(c => c.fila === dron.fila && c.col === dron.col);
        if (!celdaData) return;
        const celdaDestino = celdaData.celda;
        const renderActual = dronesActuales.get(dron.id);

        if (renderActual && renderActual.celda !== celdaDestino) {
          const imgExistente = renderActual.celda.querySelector('img.elemento-formacion');
          renderActual.celda.classList.remove('ocupada-dron', 'seleccionado');
          delete renderActual.celda.dataset.dronId;
          if (imgExistente) {
            celdaDestino.appendChild(imgExistente);
          }
        }

        celdaDestino.classList.add('ocupada-dron');
        celdaDestino.dataset.dronId = dron.id;
        idsVivos.add(dron.id);

        let img = celdaDestino.querySelector('img.elemento-formacion');
        if (!img) {
          img = document.createElement('img');
          img.className = 'elemento-formacion';
          celdaDestino.appendChild(img);
        }

        const esAereo = dron.tipo === 'DRON_AEREO';
        const srcObjetivo = esAereo
          ? '/frontend/Imagenes/DronAereo/DronAereoVistaDesdeArriba.png'
          : '/frontend/Imagenes/DronNaval/DronMisilVistaDesdeArriba.png';
        const altObjetivo = esAereo ? 'Dron Aéreo' : 'Dron Misil';
        const classObjetivo = esAereo ? 'elemento-formacion' : 'elemento-formacion dron-derecha';

        if (img.getAttribute('src') !== srcObjetivo) {
          img.setAttribute('src', srcObjetivo);
        }
        img.setAttribute('alt', altObjetivo);
        img.className = classObjetivo;
      });

      if (!selectedDron) {
        return;
      }

      const selectedId = String(selectedDron.id);
      if (!idsVivos.has(selectedId)) {
        selectedDron = null;
        if (btnMover) btnMover.disabled = true;
        if (btnDisparar) btnDisparar.disabled = true;
        return;
      }

      const celdaSeleccionada = celdas.find(c => c.celda.dataset.dronId === selectedId);
      if (celdaSeleccionada) {
        selectedDron.cell = celdaSeleccionada.celda;
        selectedDron.fila = celdaSeleccionada.fila;
        selectedDron.col = celdaSeleccionada.col;
        celdaSeleccionada.celda.classList.add('seleccionado');
      }
    }

    // ====== GENERACIÓN DE CUADRÍCULA Y RENDERIZADO DE FORMACIÓN ======
    (async function () {
      const grid = document.getElementById('grid');
      if (!grid) {
        console.error('No se encontró el elemento grid');
        return;
      }

      if (btnMover) {
        btnMover.addEventListener('click', enterMoveMode);
      }
      if (btnDisparar) {
        btnDisparar.addEventListener('click', enterShootMode);
      }
      // handler botón flecha "terminar turno"
      const btnPlay = document.getElementById('btnPlay');
      if (btnPlay) {
        btnPlay.addEventListener('click', async () => {
          if (!getPlayerIdActual()) {
            alert('Falta playerId');
            return;
          }
          try {
            await pasarTurno();
          } catch (err) {
            alert(err.message);
          }
        });
      }

      if (!getPlayerIdActual()) {
        const recuperado = await intentarRecuperarSesion();
        if (!recuperado) {
          alert('No se encontró sesión activa. Vuelve a entrar desde INICIO.');
          return;
        }
      }

      const playerIdActual = getPlayerIdActual();
      if (!playerIdActual) {
        alert('No se encontró sesión activa. Vuelve a entrar desde INICIO.');
        return;
      }

      const filasTotal = 10;     
      const colsTotal = 20;      
      celdas = [];

      for (let f = 0; f < filasTotal; f++) {
        for (let c = 0; c < colsTotal; c++) {
          const celda = document.createElement('div');
          celda.className = 'celda';
          
          celda.dataset.fila = f;
          celda.dataset.col = c;
          
          celda.addEventListener('click', async () => {
            const dronId = celda.dataset.dronId;
            if (!dronId) {
              return; // nothing to do on empty cell
            }
            const playerIdCelda = getPlayerIdActual();
            if (!playerIdCelda) {
              // TODO el playerId debería guardarse al hacer join inicial
              alert('Jugador no identificado');
              return;
            }
            try {
              const data = await apiRequest(
                `/selectDrone2?playerId=${encodeURIComponent(playerIdCelda)}&dronId=${encodeURIComponent(dronId)}`,
                'POST'
              );
              if (data.ok) {
                // visualizar selección y guardar estado
                document.querySelectorAll('.celda.seleccionado').forEach(el => el.classList.remove('seleccionado'));
                celda.classList.add('seleccionado');
                // actualizar variable global
                selectedDron = {
                  id: dronId,
                  fila: parseInt(celda.dataset.fila),
                  col: parseInt(celda.dataset.col),
                  cell: celda
                };
                // activar botón mover y cancelar cualquier modo previo
                exitMoveMode();
                exitShootMode();
                if (btnMover) {
                  btnMover.disabled = false;
                }
                if (btnDisparar) {
                  btnDisparar.disabled = false;
                }
              } else {
                alert('No se pudo seleccionar el dron: ' + (data.estado || 'ERROR'));
              }
            } catch (err) {
              alert('Error al seleccionar dron: ' + (err?.message || 'ERROR'));
            }
          });
          
          grid.appendChild(celda);
          celdas.push({ celda, fila: f, col: c });
        }
      }

      console.log('Cuadrícula creada:', filasTotal, 'filas x', colsTotal, 'columnas =', celdas.length, 'celdas');

      const equipoAsignado = getSessionValue('equipoAsignado') || 'NAVAL';
      const estrategiaGuardada = getSessionValue('estrategiaSeleccionada');
      const estrategiaSeleccionada = estrategiaValidaParaEquipo(estrategiaGuardada, equipoAsignado)
        ? estrategiaGuardada
        : estrategiaDefaultPorEquipo(equipoAsignado);

      setSessionValue('estrategiaSeleccionada', estrategiaSeleccionada);
      console.log('Estrategia seleccionada:', estrategiaSeleccionada);

      try {
        const plantilla = normalizarTipoPlantilla(estrategiaSeleccionada);
        if (plantilla) {
          const templateResp = await apiRequest(
            `/template?playerId=${encodeURIComponent(playerIdActual)}&plantilla=${encodeURIComponent(plantilla)}`,
            'POST'
          );
          if (templateResp?.ok === false && templateResp?.estado !== 'PLANTILLA_YA_BLOQUEADA') {
            alert(`No se pudo aplicar la plantilla: ${templateResp.estado || 'ERROR'}`);
            return;
          }
        }

        const board = await apiRequest(`/board?playerId=${encodeURIComponent(playerIdActual)}`);
        const formacion = convertirBoardAFormacion(board, equipoAsignado);

        if (!formacion || formacion.puertos.length === 0) {
          alert('Aún no se pudo cargar la plantilla de despliegue.');
          return;
        }

        formacion.puertos.forEach((puerto, index) => {
          const celdaData = celdas.find(c => c.fila === puerto.fila && c.col === puerto.col);
          if (celdaData) {
            celdaData.celda.classList.add('ocupada-puerto');
            
            if (index === 0) {
              const portaImg = document.createElement('img');
              
              const esPortaAereo = puerto.tipo === 'PortaAereo';
              const esHorizontal = formacion.puertos.every(p => p.fila === puerto.fila);
              
              if (esPortaAereo) {
                portaImg.src = `/frontend/Imagenes/PortaAereo/PortaAereoVistaDesdeArriba.png`;
                portaImg.alt = 'Porta Aéreo';
                const filasPuerto = formacion.puertos.map(p => p.fila);
                const colsPuerto = formacion.puertos.map(p => p.col);
                const spanFilas = Math.max(...filasPuerto) - Math.min(...filasPuerto) + 1;
                const spanCols = Math.max(...colsPuerto) - Math.min(...colsPuerto) + 1;

                if (spanCols >= spanFilas) {
                  portaImg.className = 'porta-aereo-2x5';
                } else {
                  portaImg.className = 'porta-aereo-vertical-5x2';
                }
              } else {
                portaImg.src = `/frontend/Imagenes/PortaNaval/PortaNavalVistaDeArriba.png`;
                portaImg.alt = 'Porta Naval';
                
                if (esHorizontal) {
                  portaImg.className = 'porta-naval-completo-7-celdas';
                } else {
                  portaImg.className = 'porta-naval-vertical-7-celdas';
                }
              }
              
              portaImg.onload = () => console.log('Imagen Porta cargada');
              portaImg.onerror = () => console.error('Error al cargar imagen del porta');
              celdaData.celda.appendChild(portaImg);
            }
          }
        });

        actualizarRenderDronesDesdeBoard(board);
        
        console.log('Formación Naval1 renderizada');
      } catch (error) {
        alert(`No se pudo cargar tablero desde backend: ${error.message}`);
      }
    })();

    refreshPartidaState();
    setInterval(refreshPartidaState, 1000);
  </script>
</body>
</html>